---
id: first-factor
title: "Setting up the first factor"
hide_title: true
---

import BackendSDKTabs from "/src/components/tabs/BackendSDKTabs";
import TabItem from '@theme/TabItem';
import NodeJSFrameworkSubTabsServerless from "/src/components/tabs/NodeJSFrameworkSubTabsServerless"
import GoFrameworkSubTabs from "/src/components/tabs/GoFrameworkSubTabs"
import PythonFrameworkSubTabs from "/src/components/tabs/PythonFrameworkSubTabs"
import BackendSDKCasing from "/src/components/BackendSDKCasing"
import AppInfoForm from "/src/components/appInfoForm"
import CoreInjector from "/src/components/coreInjector"

:::caution
This is the legacy method of implementing MFA. It has several [disadvantages](../legacy-vs-new) compared to using our MFA recipe.
:::

# Setting up the 1st factor


## 1) Initialisation

Start by following the recipe guide for the first factor. In this guide, we will take the example of [thirdpartyemailpassword recipe](https://supertokens.com/docs/thirdpartyemailpassword/introduction) as being the first factor.

After following the [backend quick setup section](https://supertokens.com/docs/thirdpartyemailpassword/quick-setup/backend) (or any of the framework specific integration guides), you should have all the auth APIs exposed to the frontend via the SuperTokens middleware. The `supertokens.init` code on the server would look like this:

<AppInfoForm
    askForAppName
    askForAPIDomain
    askForWebsiteDomain
>

<CoreInjector showTenantId={false}>

<BackendSDKTabs>
<TabItem value="nodejs">

<NodeJSFrameworkSubTabsServerless>
<TabItem value="express">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "express",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/thirdpartyemailpassword/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</TabItem>

<TabItem value="hapi">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "hapi",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</TabItem>

<TabItem value="fastify">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "fastify",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</TabItem>

<TabItem value="koa">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "koa",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</TabItem>

<TabItem value="loopback">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdPartyEmailPassword from"supertokens-node/recipe/thirdpartyemailpassword";

supertokens.init({
    framework: "loopback",
    supertokens: {
        ^{coreInjector_connection_uri_comment}
        connectionURI: ^{coreInjector_uri}
        ^{coreInjector_api_key_commented}apiKey: ^{coreInjector_api_key},
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{form_appName}",
        apiDomain: "^{form_apiDomain}",
        websiteDomain: "^{form_websiteDomain}",
        apiBasePath: "^{form_apiBasePath}",
        websiteBasePath: "^{form_websiteBasePath}"
    },
    recipeList: [
        ThirdPartyEmailPassword.init({/*...*/}),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</TabItem>
<TabItem value="serverless">

:::important
Please refer the **Serverless Deployment** section in the ThirdPartyEmailPassword recipe guide
:::

</TabItem>
<TabItem value="nextjs">

:::important
Please refer the **NextJS** section in the ThirdPartyEmailPassword recipe guide
:::

</TabItem>
<TabItem value="nestjs">

:::important
Please refer the **NestJS** section in the ThirdPartyEmailPassword recipe guide
:::

</TabItem>
</NodeJSFrameworkSubTabsServerless>
</TabItem>
<TabItem value="go">

```go
import (
	"github.com/supertokens/supertokens-golang/recipe/session"
	"github.com/supertokens/supertokens-golang/recipe/thirdpartyemailpassword"
	"github.com/supertokens/supertokens-golang/recipe/thirdpartyemailpassword/tpepmodels"
	"github.com/supertokens/supertokens-golang/supertokens"
    "github.com/supertokens/supertokens-golang/recipe/usermetadata"
)

func main() {
    apiBasePath := "^{form_apiBasePath}"
    websiteBasePath := "^{form_websiteBasePath}"
	err := supertokens.Init(supertokens.TypeInput{
		Supertokens: &supertokens.ConnectionInfo{
            ^{coreInjector_connection_uri_comment}
            ConnectionURI: ^{coreInjector_uri}
            ^{coreInjector_api_key_commented}APIKey: ^{coreInjector_api_key},
		},
		AppInfo: supertokens.AppInfo{
            AppName: "^{form_appName}",
            APIDomain: "^{form_apiDomain}",
            WebsiteDomain: "^{form_websiteDomain}",
            APIBasePath: &apiBasePath,
            WebsiteBasePath: &websiteBasePath,
		},
		RecipeList: []supertokens.Recipe{
			thirdpartyemailpassword.Init(&tpepmodels.TypeInput{/*...*/}),
			session.Init(nil), // initializes session features
            usermetadata.Init(nil), // initializes the user metadata feature
		},
	})

	if err != nil {
		panic(err.Error())
	}
}
```
</TabItem>
<TabItem value="python">
<PythonFrameworkSubTabs>
<TabItem value="fastapi">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdpartyemailpassword, session, usermetadata

init(
    app_info=InputAppInfo(
        app_name="^{form_appName}",
        api_domain="^{form_apiDomain}",
        website_domain="^{form_websiteDomain}",
        api_base_path="^{form_apiBasePath}",
        website_base_path="^{form_websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        ^{coreInjector_connection_uri_comment_with_hash}
        connection_uri=^{coreInjector_uri}
        ^{coreInjector_api_key_commented_with_hash}api_key=^{coreInjector_api_key}
    ),
    framework='fastapi',
    recipe_list=[
	    session.init(), # initializes session features
        usermetadata.init(), # initializes the user metadata feature
        thirdpartyemailpassword.init(
           # ...
        )
    ],
    mode='asgi' # use wsgi if you are running using gunicorn
)
```

</TabItem>
<TabItem value="flask">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdpartyemailpassword, session, usermetadata

init(
    app_info=InputAppInfo(
        app_name="^{form_appName}",
        api_domain="^{form_apiDomain}",
        website_domain="^{form_websiteDomain}",
        api_base_path="^{form_apiBasePath}",
        website_base_path="^{form_websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        ^{coreInjector_connection_uri_comment_with_hash}
        connection_uri=^{coreInjector_uri}
        ^{coreInjector_api_key_commented_with_hash}api_key=^{coreInjector_api_key}
    ),
    framework='flask',
    recipe_list=[
	    session.init(), # initializes session features
        usermetadata.init(), # initializes the user metadata feature
        thirdpartyemailpassword.init(
           # ...
        )
    ]
)
```

</TabItem>
<TabItem value="django">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdpartyemailpassword, session, usermetadata

init(
    app_info=InputAppInfo(
        app_name="^{form_appName}",
        api_domain="^{form_apiDomain}",
        website_domain="^{form_websiteDomain}",
        api_base_path="^{form_apiBasePath}",
        website_base_path="^{form_websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        ^{coreInjector_connection_uri_comment_with_hash}
        connection_uri=^{coreInjector_uri}
        ^{coreInjector_api_key_commented_with_hash}api_key=^{coreInjector_api_key}
    ),
    framework='django',
    recipe_list=[
	    session.init(), # initializes session features
        usermetadata.init(), # initializes the user metadata feature
        thirdpartyemailpassword.init(
           # ...
        )
    ],
    mode='asgi' # use wsgi if you are running django server in sync mode
)
```

</TabItem>
</PythonFrameworkSubTabs>
</TabItem>
</BackendSDKTabs>
</CoreInjector>
</AppInfoForm>

:::important
You should have also added the SuperTokens `middleware` and `errorHandler` (depending on your framework) to your application. We are not showing it in the above code snippet for brevity, but it is explained in the ThirdPartyEmailPassword recipe guide. 
:::

## 2) Adding SecondFactorClaim

After sign up or sign in of the first factor, the existence of the session signifies the completion of the first factor, but we want to explicitly mark the second factor as incomplete. This can be done by overriding the `createNewSession` function in the `Session.init` config:

<BackendSDKTabs>
<TabItem value="nodejs">

```tsx
import Session from "supertokens-node/recipe/session";
import { BooleanClaim } from "supertokens-node/recipe/session/claims";

/*
This will be used to modify the session's access token payload
to add {"2fa-completed": false} into it.
*/
// highlight-start
export const SecondFactorClaim = new BooleanClaim({
    fetchValue: () => false,
    key: "2fa-completed",
});
// highlight-end

Session.init({
    override: {
        functions: (originalImplementation) => {
            return {
                ...originalImplementation,
                /* This function is called after signing in or signing up via the first factor */
                createNewSession: async function (input) {
                    return originalImplementation.createNewSession({
                        ...input,
                        accessTokenPayload: {
                            ...input.accessTokenPayload,
                            // highlight-next-line
                            ...(await SecondFactorClaim.build(input.userId, input.recipeUserId, input.tenantId, undefined, input.userContext)),
                        },
                    });
                },
            };
        },
    },
})
```

</TabItem>
<TabItem value="go">

```go
import (
	"github.com/supertokens/supertokens-golang/recipe/session"
	"github.com/supertokens/supertokens-golang/recipe/session/claims"
	"github.com/supertokens/supertokens-golang/recipe/session/sessmodels"
	"github.com/supertokens/supertokens-golang/supertokens"
)

func main() {
	// highlight-start
	SecondFactorClaim, _ := claims.BooleanClaim("2fa-completed", func(userId, tenantId string, userContext supertokens.UserContext) (interface{}, error) {
		return false, nil
	}, nil)
	// highlight-end

	session.Init(&sessmodels.TypeInput{
		Override: &sessmodels.OverrideStruct{
			Functions: func(originalImplementation sessmodels.RecipeInterface) sessmodels.RecipeInterface {
				oCreateNewSession := *originalImplementation.CreateNewSession
				/* This function is called after signing in or signing up via the first factor */
				(*originalImplementation.CreateNewSession) = func(userID string, accessTokenPayload, sessionDataInDatabase map[string]interface{}, disableAntiCsrf *bool, tenantId string, userContext supertokens.UserContext) (sessmodels.SessionContainer, error) {
					// highlight-start
					if accessTokenPayload == nil {
						accessTokenPayload = map[string]interface{}{}
					}
					accessTokenPayload, err := SecondFactorClaim.Build(userID, tenantId, accessTokenPayload, userContext)
					if err != nil {
						return nil, err
					}
					// highlight-end
					return oCreateNewSession(userID, accessTokenPayload, sessionDataInDatabase, disableAntiCsrf, tenantId, userContext)
				}
				return originalImplementation
			},
		},
	})
}
```

</TabItem>
<TabItem value="python">

```python
from supertokens_python.recipe import session
from supertokens_python.recipe.session.claims import BooleanClaim
from supertokens_python.recipe.session.interfaces import RecipeInterface
from typing import Any, Dict, Optional

# This will be used to modify the session's access token payload
# to add {"2fa-completed": false} into it.
# highlight-start
SecondFactorClaim = BooleanClaim(
    key="2fa-completed", fetch_value=lambda _, __, ___: False)
# highlight-end


def override_session_functions(original_implementation: RecipeInterface):
    original_create_new_session = original_implementation.create_new_session

    async def create_new_session(
        user_id: str,
        access_token_payload: Optional[Dict[str, Any]],
        session_data_in_database: Optional[Dict[str, Any]],
        disable_anti_csrf: Optional[bool],
        tenant_id: str,
        user_context: Dict[str, Any],
    ):
        # This function is called after signing in or signing up via the first factor

        if access_token_payload is None:
            access_token_payload = {}

        # highlight-next-line
        access_token_payload = {**access_token_payload, **(await SecondFactorClaim.build(user_id, tenant_id, user_context))}
        return await original_create_new_session(
            user_id, access_token_payload, session_data_in_database, disable_anti_csrf, tenant_id, user_context
        )

    original_implementation.create_new_session = create_new_session
    return original_implementation


session.init(
    # highlight-next-line
    override=session.InputOverrideConfig(functions=override_session_functions)
)
```

</TabItem>
</BackendSDKTabs>

We add `SecondFactorClaim` into the access token payload. This will be set to false on session creation (see `fetchValue` in the claim definition).