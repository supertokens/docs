---
id: first-factor
title: Setting up the first factor
hide_title: true
sidebar_position: 1
description: >-
  Set up the first authentication factor using SuperTokens with various
  frameworks.
page_type: guide
recipe: mfa
category: multi-factor-authentication
---


# Setting up the 1st factor

## 1. Initialisation

Start by following the recipe guide for the first factor. In this guide, we will take the example of `thirdparty` and `emailpassword` recipes as being the first factor.

After following the [backend quick setup section](/docs/quickstart/backend-setup) (or any of the framework specific integration guides), you should have all the auth APIs exposed to the frontend via the SuperTokens middleware. The `supertokens.init` code on the server would look like this:

<AppInfoForm />

<BackendTabs>
<BackendTabs.TabItem value="nodejs">

<NodeFrameworksCard exclude={["awsLambda", "nextjs", "nestjs"]} showAppTypeSelect>
<NodeFrameworksCard.Content value="express">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdParty from "supertokens-node/recipe/thirdparty"
import EmailPassword from "supertokens-node/recipe/emailpassword"

supertokens.init({
    framework: "express",
    supertokens: {
        connectionURI: "^{coreInfo.uri}",
        apiKey: "^{coreInfo.key}",
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/thirdpartyemailpassword/appinfo
        appName: "^{appInfo.appName}",
        apiDomain: "^{appInfo.apiDomain}",
        websiteDomain: "^{appInfo.websiteDomain}",
        apiBasePath: "^{appInfo.apiBasePath}",
        websiteBasePath: "^{appInfo.websiteBasePath}"
    },
    recipeList: [
        ThirdParty.init({
            //...
        }),
        EmailPassword.init({
            //...
        }),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</NodeFrameworksCard.Content>

<NodeFrameworksCard.Content value="hapi">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdParty from "supertokens-node/recipe/thirdparty"
import EmailPassword from "supertokens-node/recipe/emailpassword"

supertokens.init({
    framework: "hapi",
    supertokens: {
        connectionURI: "^{coreInfo.uri}",
        apiKey: "^{coreInfo.key}",
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{appInfo.appName}",
        apiDomain: "^{appInfo.apiDomain}",
        websiteDomain: "^{appInfo.websiteDomain}",
        apiBasePath: "^{appInfo.apiBasePath}",
        websiteBasePath: "^{appInfo.websiteBasePath}"
    },
    recipeList: [
        ThirdParty.init({
            //...
        }),
        EmailPassword.init({
            //...
        }),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</NodeFrameworksCard.Content>

<NodeFrameworksCard.Content value="fastify">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdParty from "supertokens-node/recipe/thirdparty"
import EmailPassword from "supertokens-node/recipe/emailpassword"

supertokens.init({
    framework: "fastify",
    supertokens: {
        connectionURI: "^{coreInfo.uri}",
        apiKey: "^{coreInfo.key}",
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{appInfo.appName}",
        apiDomain: "^{appInfo.apiDomain}",
        websiteDomain: "^{appInfo.websiteDomain}",
        apiBasePath: "^{appInfo.apiBasePath}",
        websiteBasePath: "^{appInfo.websiteBasePath}"
    },
    recipeList: [
        ThirdParty.init({
            //...
        }),
        EmailPassword.init({
            //...
        }),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</NodeFrameworksCard.Content>

<NodeFrameworksCard.Content value="koa">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdParty from "supertokens-node/recipe/thirdparty"
import EmailPassword from "supertokens-node/recipe/emailpassword"

supertokens.init({
    framework: "koa",
    supertokens: {
        connectionURI: "^{coreInfo.uri}",
        apiKey: "^{coreInfo.key}",
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{appInfo.appName}",
        apiDomain: "^{appInfo.apiDomain}",
        websiteDomain: "^{appInfo.websiteDomain}",
        apiBasePath: "^{appInfo.apiBasePath}",
        websiteBasePath: "^{appInfo.websiteBasePath}"
    },
    recipeList: [
        ThirdParty.init({
            //...
        }),
        EmailPassword.init({
            //...
        }),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</NodeFrameworksCard.Content>

<NodeFrameworksCard.Content value="loopback">

```tsx
import supertokens from "supertokens-node";
import Session from "supertokens-node/recipe/session";
import UserMetadata from "supertokens-node/recipe/usermetadata";
import ThirdParty from "supertokens-node/recipe/thirdparty"
import EmailPassword from "supertokens-node/recipe/emailpassword"

supertokens.init({
    framework: "loopback",
    supertokens: {
        connectionURI: "^{coreInfo.uri}",
        apiKey: "^{coreInfo.key}",
    },
    appInfo: {
        // learn more about this on https://supertokens.com/docs/session/appinfo
        appName: "^{appInfo.appName}",
        apiDomain: "^{appInfo.apiDomain}",
        websiteDomain: "^{appInfo.websiteDomain}",
        apiBasePath: "^{appInfo.apiBasePath}",
        websiteBasePath: "^{appInfo.websiteBasePath}"
    },
    recipeList: [
        ThirdParty.init({
            //...
        }),
        EmailPassword.init({
            //...
        }),
        Session.init(), // initializes session features
        UserMetadata.init() // initializes the user metadata feature
    ]
});
```
</NodeFrameworksCard.Content>
// <NodeFrameworksCard.Content value="serverless">
//
// :::important
// Please refer the **serverless deployment** section in the ThirdParty + EmailPassword recipe guide
// :::
//
// </NodeFrameworksCard.Content>
// <NodeFrameworksCard.Content value="nextjs">
//
// :::important
// Please refer the **NextJS** section in the ThirdParty + EmailPassword recipe guide
// :::
//
// </NodeFrameworksCard.Content>
// <NodeFrameworksCard.Content value="nestjs">
//
// :::important
// Please refer the **NestJS** section in the ThirdParty + EmailPassword recipe guide
// :::
//
// </NodeFrameworksCard.Content>
</NodeFrameworksCard>
</BackendTabs.TabItem>

<BackendTabs.TabItem value="go">

```go showAppTypeSelect
import (
	"github.com/supertokens/supertokens-golang/recipe/emailpassword"
	"github.com/supertokens/supertokens-golang/recipe/emailpassword/epmodels"
	"github.com/supertokens/supertokens-golang/recipe/session"
	"github.com/supertokens/supertokens-golang/recipe/thirdparty"
	"github.com/supertokens/supertokens-golang/recipe/thirdparty/tpmodels"
	"github.com/supertokens/supertokens-golang/recipe/usermetadata"
	"github.com/supertokens/supertokens-golang/supertokens"
)

func main() {
    apiBasePath := "^{appInfo.apiBasePath}"
    websiteBasePath := "^{appInfo.websiteBasePath}"
	err := supertokens.Init(supertokens.TypeInput{
		Supertokens: &supertokens.ConnectionInfo{
            ConnectionURI: "^{coreInfo.uri}",
            APIKey: "^{coreInfo.key}",
		},
		AppInfo: supertokens.AppInfo{
            AppName: "^{appInfo.appName}",
            APIDomain: "^{appInfo.apiDomain}",
            WebsiteDomain: "^{appInfo.websiteDomain}",
            APIBasePath: &apiBasePath,
            WebsiteBasePath: &websiteBasePath,
		},
		RecipeList: []supertokens.Recipe{
			thirdparty.Init(&tpmodels.TypeInput{ /*...*/ }),
			emailpassword.Init(&epmodels.TypeInput{ /*...*/ }),
			session.Init(nil), // initializes session features
            usermetadata.Init(nil), // initializes the user metadata feature
		},
	})

	if err != nil {
		panic(err.Error())
	}
}
```
</BackendTabs.TabItem>
<BackendTabs.TabItem value="python">

<PythonFrameworksCard showAppTypeSelect>
<PythonFrameworksCard.Content value="fastapi">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdparty, emailpassword, session, usermetadata

init(
    app_info=InputAppInfo(
        app_name="^{appInfo.appName}",
        api_domain="^{appInfo.apiDomain}",
        website_domain="^{appInfo.websiteDomain}",
        api_base_path="^{appInfo.apiBasePath}",
        website_base_path="^{appInfo.websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        connection_uri="^{coreInfo.uri}",
        api_key="^{coreInfo.key}"
    ),
    framework='fastapi',
    recipe_list=[
	    session.init(), # initializes session features
        usermetadata.init(), # initializes the user metadata feature
        thirdparty.init(
           # ...
        ),
        emailpassword.init(
            # ...
        )
    ],
    mode='asgi' # use wsgi if you are running using gunicorn
)
```

</PythonFrameworksCard.Content>
<PythonFrameworksCard.Content value="flask">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdparty, emailpassword, session, usermetadata

init(
    app_info=InputAppInfo(
        app_name="^{appInfo.appName}",
        api_domain="^{appInfo.apiDomain}",
        website_domain="^{appInfo.websiteDomain}",
        api_base_path="^{appInfo.apiBasePath}",
        website_base_path="^{appInfo.websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        connection_uri="^{coreInfo.uri}",
        api_key="^{coreInfo.key}"
    ),
    framework='flask',
    recipe_list=[
	    session.init(), # initializes session features
        usermetadata.init(), # initializes the user metadata feature
        thirdparty.init(
           # ...
        ),
        emailpassword.init(
            # ...
        )
    ]
)
```

</PythonFrameworksCard.Content>
<PythonFrameworksCard.Content value="django">

```python
from supertokens_python import init, InputAppInfo, SupertokensConfig
from supertokens_python.recipe import thirdparty, emailpassword, session, usermetadata

init(
    app_info=InputAppInfo(
        app_name="^{appInfo.appName}",
        api_domain="^{appInfo.apiDomain}",
        website_domain="^{appInfo.websiteDomain}",
        api_base_path="^{appInfo.apiBasePath}",
        website_base_path="^{appInfo.websiteBasePath}"
    ),
    supertokens_config=SupertokensConfig(
        connection_uri="^{coreInfo.uri}",
        api_key="^{coreInfo.key}"
    ),
    framework='django',
    recipe_list=[
	    session.init(), # initializes session features
        usermetadata.init(), # initializes the user metadata feature
        thirdparty.init(
           # ...
        ),
        emailpassword.init(
            # ...
        )
    ],
    mode='asgi' # use wsgi if you are running django server in sync mode
)
```

</PythonFrameworksCard.Content>
</PythonFrameworksCard>
</BackendTabs.TabItem>
</BackendTabs>

:::important
You should have also added the SuperTokens `middleware` and `errorHandler` (depending on your framework) to your application. We are not showing it in the above code snippet for brevity, but it is explained in the ThirdParty + EmailPassword recipe guide. 
:::

## 2. Adding second factor claim

After sign up or sign in of the first factor, the existence of the session signifies the completion of the first factor, but we want to explicitly mark the second factor as incomplete. This can be done by overriding the `createNewSession` function in the `Session.init` config:

<BackendTabs>
<BackendTabs.TabItem value="nodejs">

```tsx
import Session from "supertokens-node/recipe/session";
import { BooleanClaim } from "supertokens-node/recipe/session/claims";

/*
This will be used to modify the session's access token payload
to add {"2fa-completed": false} into it.
*/
// highlight-start
export const SecondFactorClaim = new BooleanClaim({
    fetchValue: () => false,
    key: "2fa-completed",
});
// highlight-end

Session.init({
    override: {
        functions: (originalImplementation) => {
            return {
                ...originalImplementation,
                /* This function is called after signing in or signing up via the first factor */
                createNewSession: async function (input) {
                    return originalImplementation.createNewSession({
                        ...input,
                        accessTokenPayload: {
                            ...input.accessTokenPayload,
                            // highlight-next-line
                            ...(await SecondFactorClaim.build(input.userId, input.recipeUserId, input.tenantId, undefined, input.userContext)),
                        },
                    });
                },
            };
        },
    },
})
```

</BackendTabs.TabItem>
<BackendTabs.TabItem value="go">

```go
import (
	"github.com/supertokens/supertokens-golang/recipe/session"
	"github.com/supertokens/supertokens-golang/recipe/session/claims"
	"github.com/supertokens/supertokens-golang/recipe/session/sessmodels"
	"github.com/supertokens/supertokens-golang/supertokens"
)

func main() {
	// highlight-start
	SecondFactorClaim, _ := claims.BooleanClaim("2fa-completed", func(userId, tenantId string, userContext supertokens.UserContext) (interface{}, error) {
		return false, nil
	}, nil)
	// highlight-end

	session.Init(&sessmodels.TypeInput{
		Override: &sessmodels.OverrideStruct{
			Functions: func(originalImplementation sessmodels.RecipeInterface) sessmodels.RecipeInterface {
				oCreateNewSession := *originalImplementation.CreateNewSession
				/* This function is called after signing in or signing up via the first factor */
				(*originalImplementation.CreateNewSession) = func(userID string, accessTokenPayload, sessionDataInDatabase map[string]interface{}, disableAntiCsrf *bool, tenantId string, userContext supertokens.UserContext) (sessmodels.SessionContainer, error) {
					// highlight-start
					if accessTokenPayload == nil {
						accessTokenPayload = map[string]interface{}{}
					}
					accessTokenPayload, err := SecondFactorClaim.Build(userID, tenantId, accessTokenPayload, userContext)
					if err != nil {
						return nil, err
					}
					// highlight-end
					return oCreateNewSession(userID, accessTokenPayload, sessionDataInDatabase, disableAntiCsrf, tenantId, userContext)
				}
				return originalImplementation
			},
		},
	})
}
```

</BackendTabs.TabItem>
<BackendTabs.TabItem value="python">

```python
from supertokens_python.recipe import session
from supertokens_python.recipe.session.claims import BooleanClaim
from supertokens_python.recipe.session.interfaces import RecipeInterface
from typing import Any, Dict, Optional
from supertokens_python.types import RecipeUserId

# This will be used to modify the session's access token payload
# to add {"2fa-completed": false} into it.
# highlight-start
SecondFactorClaim = BooleanClaim(
    key="2fa-completed", fetch_value=lambda _, __, ___, ____, _____: False
)
# highlight-end


def override_session_functions(original_implementation: RecipeInterface):
    original_create_new_session = original_implementation.create_new_session

    async def create_new_session(
        user_id: str,
        recipe_user_id: RecipeUserId,
        access_token_payload: Optional[Dict[str, Any]],
        session_data_in_database: Optional[Dict[str, Any]],
        disable_anti_csrf: Optional[bool],
        tenant_id: str,
        user_context: Dict[str, Any],
    ):
        # This function is called after signing in or signing up via the first factor

        if access_token_payload is None:
            access_token_payload = {}

        # highlight-next-line
        access_token_payload = {
            **access_token_payload,
            **(
                await SecondFactorClaim.build(
                    user_id,
                    recipe_user_id,
                    tenant_id,
                    access_token_payload,
                    user_context,
                )
            ),
        }
        return await original_create_new_session(
            user_id,
            recipe_user_id,
            access_token_payload,
            session_data_in_database,
            disable_anti_csrf,
            tenant_id,
            user_context,
        )

    original_implementation.create_new_session = create_new_session
    return original_implementation


session.init(
    # highlight-next-line
    override=session.InputOverrideConfig(functions=override_session_functions)
)
```

</BackendTabs.TabItem>
</BackendTabs>

We add `SecondFactorClaim` into the access token payload. This will be set to false on session creation (see `fetchValue` in the claim definition).
